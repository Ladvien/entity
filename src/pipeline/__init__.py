"""Pipeline component:   init  ."""

from importlib import import_module
from typing import TYPE_CHECKING, Any

# Expose plugin configuration API used by the pipeline package
from entity.core import plugin_utils


# Registry classes are no longer imported eagerly.
# Access ``PluginRegistry`` and related classes via ``registry`` or
# rely on this module's ``__getattr__`` for lazy loading.
from .stages import PipelineStage

if TYPE_CHECKING:  # pragma: no cover - imported for type checking only
    from .state import FailureInfo, LLMResponse, PipelineState

__all__ = [
    "PipelineStage",
    "PipelineState",
    "PluginContext",
    "ConversationEntry",
    "ToolCall",
    "LLMResponse",
    "FailureInfo",
    "MetricsCollector",
    "BasePlugin",
    "ResourcePlugin",
    "ToolPlugin",
    "PromptPlugin",
    "AdapterPlugin",
    "FailurePlugin",
    "AutoGeneratedPlugin",
    "plugin",
    "PluginAutoClassifier",
    "ValidationResult",
    "ReconfigResult",
    "ConfigurationError",
    "ClassRegistry",
    "SystemInitializer",
    "import_plugin_class",
    "initialization_cleanup_context",
    "execute_pipeline",
    "create_default_response",
    "create_static_error_response",
    "ConfigUpdateResult",
    "update_plugin_configuration",
    "validate_topology",
    "StateLogger",
    "LogReplayer",
    "Agent",
    "AgentBuilder",
    "PipelineManager",
    "execute_with_observability",
]


def __getattr__(name: str) -> Any:
    """Lazily expose heavy pipeline modules."""

    if name in {
        "PluginRegistry",
        "ResourceContainer",
        "SystemRegistries",
        "ToolRegistry",
        "ClassRegistry",
        "SystemInitializer",
        "initialization_cleanup_context",
    }:
        from registry import (
            PluginRegistry,
            ResourceContainer,
            SystemRegistries,
            ToolRegistry,
        )
        from .initializer import (
            ClassRegistry,
            SystemInitializer,
            initialization_cleanup_context,
        )

        return {
            "PluginRegistry": PluginRegistry,
            "ResourceContainer": ResourceContainer,
            "SystemRegistries": SystemRegistries,
            "ToolRegistry": ToolRegistry,
            "ClassRegistry": ClassRegistry,
            "SystemInitializer": SystemInitializer,
            "initialization_cleanup_context": initialization_cleanup_context,
        }[name]

    heavy_imports = {
        "Agent": "pipeline.agent",
        "AgentBuilder": "pipeline.builder",
        "AgentRuntime": "pipeline.runtime",
        "PipelineManager": "pipeline.manager",
        "execute_pipeline": "pipeline.pipeline",
        "create_default_response": "pipeline.pipeline",
        "create_static_error_response": "pipeline.errors",
        "ConfigUpdateResult": "pipeline.config_update",
        "update_plugin_configuration": "pipeline.config_update",
        "StateLogger": "entity.core.state_logger",
        "LogReplayer": "entity.core.state_logger",
        "ClassRegistry": "pipeline.initializer",
        "SystemInitializer": "pipeline.initializer",
        "initialization_cleanup_context": "pipeline.initializer",
        "PluginAutoClassifier": "pipeline.interfaces",
        "import_plugin_class": "pipeline.interfaces",
        "MetricsCollector": "pipeline.metrics",
        "LLM": "pipeline.resources",
        "BaseResource": "pipeline.resources",
        "Resource": "pipeline.resources",
        "PipelineStage": "pipeline.stages",
        "PluginContext": "pipeline.context",
        "ConversationEntry": "pipeline.context",
        "ToolCall": "pipeline.context",
        "FailureInfo": "pipeline.state",
        "LLMResponse": "pipeline.state",
        "PipelineState": "pipeline.state",
        "BasePlugin": "entity.core.plugins.base",
        "ResourcePlugin": "entity.core.plugins.base",
        "ToolPlugin": "entity.core.plugins.base",
        "PromptPlugin": "entity.core.plugins.base",
        "AdapterPlugin": "entity.core.plugins.base",
        "FailurePlugin": "entity.core.plugins.base",
        "AutoGeneratedPlugin": "entity.core.plugins.base",
        "ValidationResult": "entity.core.plugins.base",
        "ReconfigResult": "entity.core.plugins.base",
        "ConfigurationError": "entity.core.plugins.base",
    }

    if name in heavy_imports:
        module = import_module(heavy_imports[name])
        attr = getattr(module, name)
        if (
            name
            in {"BasePlugin", "PromptPlugin", "AdapterPlugin", "AutoGeneratedPlugin"}
            and plugin_utils.plugin_base_registry.auto_plugin is object
        ):
            plugin_utils.configure_plugins(
                module.BasePlugin,
                module.PromptPlugin,
                module.AdapterPlugin,
                module.AutoGeneratedPlugin,
            )
        return attr

    raise AttributeError(f"module {__name__} has no attribute {name}")
