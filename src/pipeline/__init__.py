from typing import Any

from common_interfaces import plugins as plugin_utils

from .agent import Agent
from .base_plugins import (
    AdapterPlugin,
    AutoGeneratedPlugin,
    BasePlugin,
    ConfigurationError,
    FailurePlugin,
    PromptPlugin,
    ReconfigResult,
    ResourcePlugin,
    ToolPlugin,
    ValidationResult,
)
from .builder import AgentBuilder
from .config_update import ConfigUpdateResult, update_plugin_configuration
from .context import ConversationEntry, PluginContext, ToolCall
from .conversation_manager import ConversationManager
from .decorators import plugin
from .errors import create_static_error_response
from .initializer import (
    ClassRegistry,
    SystemInitializer,
    initialization_cleanup_context,
)
from .interfaces import PluginAutoClassifier, import_plugin_class
from .manager import PipelineManager
from .metrics import MetricsCollector
from .observability import execute_with_observability
from .pipeline import create_default_response, execute_pipeline

# Registry classes are no longer imported eagerly.
# Access ``PluginRegistry`` and related classes via ``registry`` or
# rely on this module's ``__getattr__`` for lazy loading.
from .resources import LLM, BaseResource, Resource
from .runtime import AgentRuntime
from .stages import PipelineStage
from .user_plugins import BasePlugin

from importlib import import_module
from typing import TYPE_CHECKING, Any

# Expose plugin configuration API used by the pipeline package
from common_interfaces import plugins as plugin_utils

if TYPE_CHECKING:  # pragma: no cover - imported for type checking only
    from .agent import Agent
    from .base_plugins import (
        AdapterPlugin,
        AutoGeneratedPlugin,
        BasePlugin,
        ConfigurationError,
        FailurePlugin,
        PromptPlugin,
        ReconfigResult,
        ResourcePlugin,
        ToolPlugin,
        ValidationResult,
    )
    from .builder import AgentBuilder
    from .config_update import ConfigUpdateResult, update_plugin_configuration
    from .context import ConversationEntry, PluginContext, ToolCall
    from .conversation_manager import ConversationManager
    from .decorators import plugin
    from .errors import create_static_error_response
    from .initializer import (
        ClassRegistry,
        SystemInitializer,
        initialization_cleanup_context,
    )
    from .interfaces import PluginAutoClassifier, import_plugin_class
    from .manager import PipelineManager
    from .metrics import MetricsCollector
    from .observability import execute_with_observability
    from .pipeline import create_default_response, execute_pipeline
    from .resources import LLM, BaseResource, Resource
    from .runtime import AgentRuntime
    from .stages import PipelineStage
    from .state import FailureInfo, LLMResponse, PipelineState

__all__ = [
    "PipelineStage",
    "PipelineState",
    "PluginContext",
    "ConversationEntry",
    "ToolCall",
    "LLMResponse",
    "LLM",
    "Resource",
    "BaseResource",
    "FailureInfo",
    "MetricsCollector",
    "BasePlugin",
    "ResourcePlugin",
    "ToolPlugin",
    "PromptPlugin",
    "AdapterPlugin",
    "FailurePlugin",
    "AutoGeneratedPlugin",
    "plugin",
    "PluginAutoClassifier",
    "ValidationResult",
    "ReconfigResult",
    "ConfigurationError",
    "ClassRegistry",
    "SystemInitializer",
    "import_plugin_class",
    "initialization_cleanup_context",
    "execute_pipeline",
    "create_default_response",
    "create_static_error_response",
    "ConfigUpdateResult",
    "update_plugin_configuration",
    "Agent",
    "AgentBuilder",
    "AgentRuntime",
    "PipelineManager",
    "ConversationManager",
    "execute_with_observability",
]


def __getattr__(name: str) -> Any:
    """Lazily expose heavy pipeline modules."""

    if name in {
        "PluginRegistry",
        "ResourceContainer",
        "SystemRegistries",
        "ToolRegistry",
        "ClassRegistry",
        "SystemInitializer",
        "initialization_cleanup_context",
    }:
        from registry import (
            PluginRegistry,
            ResourceContainer,
            SystemRegistries,
            ToolRegistry,
        )

        return {
            "PluginRegistry": PluginRegistry,
            "ResourceContainer": ResourceContainer,
            "SystemRegistries": SystemRegistries,
            "ToolRegistry": ToolRegistry,
            "ClassRegistry": ClassRegistry,
            "SystemInitializer": SystemInitializer,
            "initialization_cleanup_context": initialization_cleanup_context,
        }[name]

    heavy_imports = {
        "Agent": "pipeline.agent",
        "AgentBuilder": "pipeline.builder",
        "AgentRuntime": "pipeline.runtime",
        "PipelineManager": "pipeline.manager",
        "ConversationManager": "pipeline.conversation_manager",
        "execute_pipeline": "pipeline.pipeline",
        "create_default_response": "pipeline.pipeline",
        "create_static_error_response": "pipeline.errors",
        "ConfigUpdateResult": "pipeline.config_update",
        "update_plugin_configuration": "pipeline.config_update",
        "ClassRegistry": "pipeline.initializer",
        "SystemInitializer": "pipeline.initializer",
        "initialization_cleanup_context": "pipeline.initializer",
        "PluginAutoClassifier": "pipeline.interfaces",
        "import_plugin_class": "pipeline.interfaces",
        "MetricsCollector": "pipeline.metrics",
        "LLM": "pipeline.resources",
        "BaseResource": "pipeline.resources",
        "Resource": "pipeline.resources",
        "PipelineStage": "pipeline.stages",
        "PluginContext": "pipeline.context",
        "ConversationEntry": "pipeline.context",
        "ToolCall": "pipeline.context",
        "FailureInfo": "pipeline.state",
        "LLMResponse": "pipeline.state",
        "PipelineState": "pipeline.state",
        "BasePlugin": "pipeline.base_plugins",
        "ResourcePlugin": "pipeline.base_plugins",
        "ToolPlugin": "pipeline.base_plugins",
        "PromptPlugin": "pipeline.base_plugins",
        "AdapterPlugin": "pipeline.base_plugins",
        "FailurePlugin": "pipeline.base_plugins",
        "AutoGeneratedPlugin": "pipeline.base_plugins",
        "ValidationResult": "pipeline.base_plugins",
        "ReconfigResult": "pipeline.base_plugins",
        "ConfigurationError": "pipeline.base_plugins",
    }

    if name in heavy_imports:
        module = import_module(heavy_imports[name])
        attr = getattr(module, name)
        if (
            name
            in {"BasePlugin", "PromptPlugin", "AdapterPlugin", "AutoGeneratedPlugin"}
            and plugin_utils.AutoGeneratedPluginType is object
        ):
            plugin_utils.configure_plugins(
                module.BasePlugin,
                module.PromptPlugin,
                module.AdapterPlugin,
                module.AutoGeneratedPlugin,
            )
        return attr

    raise AttributeError(f"module {__name__} has no attribute {name}")
